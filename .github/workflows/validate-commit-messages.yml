name: Validate Commit Messages

on:
  push:
  pull_request:

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history to get all commits
    
    - name: Validate commit messages
      run: |
        # Determine commit range based on event type
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # For PRs, validate commits in the PR
          COMMIT_RANGE="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
        else
          # For pushes, determine the range carefully
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # New branch, validate only the latest commit
            COMMIT_RANGE="HEAD~1..HEAD"
          else
            # Check if the before SHA exists in the current repository
            if git cat-file -e "${{ github.event.before }}" 2>/dev/null; then
              # Before SHA exists, validate commits in this push
              COMMIT_RANGE="${{ github.event.before }}..${{ github.event.after }}"
            else
              # Before SHA doesn't exist (force push), validate only the latest commit
              echo "Warning: Before SHA ${{ github.event.before }} not found (likely force push)"
              echo "Falling back to validating only the latest commit"
              COMMIT_RANGE="HEAD~1..HEAD"
            fi
          fi
        fi
        
        echo "Using commit range: $COMMIT_RANGE"
        echo "Commits to validate:"
        git log --oneline "$COMMIT_RANGE" || echo "Failed to list commits in range"
        
        # Debug: Show environment info
        echo "GitHub event: ${{ github.event_name }}"
        echo "Before SHA: ${{ github.event.before }}"
        echo "After SHA: ${{ github.event.after }}"
        
        # Ensure script is executable  
        chmod +x ./scripts/validate-commits.sh
        
        # Run the validation script
        echo "About to run validation..."
        ./scripts/validate-commits.sh --range "$COMMIT_RANGE" --verbose
        echo "âœ… Validation completed successfully"
